<html>
<head>
  <meta charset="utf-8">
  <title>Hello world</title>
  <!-- Script tags including React -->
  <script src="./js/react.min.js"></script>
  <script src="./js/react-dom.min.js"></script>
  <script src="./js/browser.min.js"></script>
  <link rel="stylesheet" type="text/css" href="index.css">
  <link rel="stylesheet" type="text/css" href="search.css">
</head>
<body>
  <div id="app"></div>
  <script type="text/babel">
  let coinFilterVar = 'bitcoin';
  class App extends React.Component {
    constructor(props) {
      super(props);
      chrome.storage.sync.get("coinFilterStore", function(items) {
        if (!chrome.runtime.error) {
          coinFilterVar=items.coinFilterStore;
        }
      });
      this.state = {
        isLoading: true,
        tickers: [],
        coinFilters: coinFilterVar
      }
      this.handleChange = this.handleChange.bind(this);
    }

    handleChange(event) {
      coinFilterVar = event.target.value;
      chrome.storage.sync.set({ "coinFilterStore" : coinFilterVar }, function() {
        if (chrome.runtime.error) {
          console.log("Runtime error.");
        }
        console.log(coinFilterVar);
      });
      this.setState({coinFilters: event.target.value});
    }
    componentWillMount() {
      fetch("https://api.coinmarketcap.com/v1/ticker/")
      .then((response) => response.json()) // Transform the data into json
      .then(data => this.setState({
          isLoading: false,
          tickers: data
        }))
      .catch(error => console.log('parsing failed', error))
    }
    render() {
      chrome.storage.sync.get("coinFilterStore", function(items) {
        if (!chrome.runtime.error) {
          coinFilterVar=items.coinFilterStore;
          console.log("get"+coinFilterVar);
        }
      });
      let filterText = coinFilterVar.toLowerCase().split(',');
      return (
        <div>
          <input type="search" value={coinFilterVar} placeholder="Search eg: bitcoin,ethereum,nav-coin" className="search-input" onChange={this.handleChange}/>
          <br/>
          <ul className="list">
          {this.state.tickers
            .filter(function(ticker, index) {
            return filterText.includes(ticker.id);
            })
            .map(function(ticker, index){
            var imgsrc = "https://files.coinmarketcap.com/static/img/coins/64x64/"+ticker.id+".png";
            return  <li className="list__item">
                      <div className="list__item__left">
                        <img className="list__item__thumbnail" src= {imgsrc} alt={ticker.name}/>
                      </div>

                      <div className="list__item__center">
                        <div className="list__item__title">{ticker.name} ({ticker.symbol})</div>
                        <div className="list__item__subtitle">${ticker.price_usd} {ticker.price_btc} BTC 1h {ticker.percent_change_1h}| 24h {ticker.percent_change_24h}| 7d {ticker.percent_change_7d}</div>
                      </div>
                    </li>;
                })}
          </ul>
        </div>
      )
    }
  }
  var mount = document.querySelector('#app');
  ReactDOM.render(<App />, mount);
  </script>
</body>
</html>
